-- Nếu đã có script trước đó đang chạy, thì sẽ xóa nó.
if _G.GlitchScriptRunning then
    _G.GlitchScriptRunning = false
    if _G.GlitchCleanup then
        _G.GlitchCleanup() -- Gọi hàm dọn dẹp nếu có
    end
    wait(0.1) -- Thời gian chờ ngắn để đảm bảo script cũ bị tắt hoàn toàn
end

-- Đặt biến báo hiệu script đang chạy
_G.GlitchScriptRunning = true

--//Services\\--
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local Workspace = game:GetService("Workspace")
local Players = game:GetService("Players")
local LPlayer = Players.LocalPlayer
local ChatService = game:GetService("ReplicatedStorage").DefaultChatSystemChatEvents
local Mouse = LPlayer:GetMouse()

--//Variables\\--
local Remotes = ReplicatedStorage:WaitForChild("Remotes")
local StampAsset = Remotes:WaitForChild("StampAsset")
local DeleteAsset = Remotes:WaitForChild("DeleteAsset")

local ActiveParts
local Plates = Workspace:WaitForChild("Plates")
local LPlate
local MSpikes = {}

-- Tìm Plate của người chơi
for _, Plate in pairs(Plates:GetChildren()) do
    if Plate:FindFirstChild("Owner") and Plate.Owner.Value == LPlayer then
        LPlate = Plate:FindFirstChild("Plate")
        ActiveParts = Plate:FindFirstChild("ActiveParts")
        break
    end
end

-- Cập nhật danh sách MSpikes khi Block mới được thêm vào
ActiveParts.ChildAdded:Connect(function(Block)
    if Block.Name == "Spikes - Moving" then
        local MSpike = Block:WaitForChild("Spike_Retracting"):WaitForChild("Spikes")
        table.insert(MSpikes, MSpike)
        Block.AncestryChanged:Wait()
        if not Block.Parent then
            table.remove(MSpikes, table.find(MSpikes, MSpike))
        end
    end
end)

local Module = {}

function Module.CreateSpike(CF, Weld)
    return StampAsset:InvokeServer(41324903, CF, "{bf0c5c8b-6f25-4321-9251-300beb818121}", Weld or {}, 0)
end

function Module.CreateMSpike(CF, Weld)
    return StampAsset:InvokeServer(41324904, CF, "{fca81e11-1ead-4817-afde-4dc29e72ea1b}", Weld or {}, 0)
end

function Module.Weld(...)
    StampAsset:InvokeServer(
        56451715,
        LPlate.CFrame + Vector3.new(0, 200, 0),
        "{3ae31e60-5cd0-4d80-96b6-a1dd894ece8a}",
        {...},
        0
    )
end

function Module.Hang(Part)
    Module.CreateMSpike(
        (LPlate.CFrame * CFrame.fromEulerAnglesXYZ(math.rad(math.random(0, 360)), math.rad(math.random(0, 360)), math.rad(math.random(0, 360)))) - Vector3.new(0, -5, 0),
        {LPlate}
    )
    Module.Weld(Part, MSpikes[#MSpikes])
end

-- Hàm nhận diện player theo username hoặc display name
function FindPlayerByName(Name)
    for _, Player in pairs(Players:GetPlayers()) do
        if string.find(string.lower(Player.Name), string.lower(Name)) or string.find(string.lower(Player.DisplayName), string.lower(Name)) then
            return Player
        end
    end
end

local loopGlitchActive = {}

-- Hàm khôi phục trạng thái looping cho người chơi mới
local function RestoreLoopForPlayer(player)
    if loopGlitchActive[player.Name] then
        spawn(function()
            while loopGlitchActive[player.Name] and _G.GlitchScriptRunning do
                local targetPart = player.Character and player.Character:FindFirstChild("HumanoidRootPart")
                if targetPart then
                    Module.Hang(targetPart)
                end
                wait(1) -- Điều chỉnh thời gian lặp lại tùy theo yêu cầu
            end
        end)
    end
end

-- Lệnh chat để kích hoạt 'Hang' và 'Loop Hang'
ChatService.OnMessageDoneFiltering.OnClientEvent:Connect(function(messageData)
    if not _G.GlitchScriptRunning then return end -- Dừng lại nếu script đã bị hủy
    local message = string.lower(messageData.Message)
    local speaker = Players:FindFirstChild(messageData.FromSpeaker)
    
    if speaker == LPlayer then
        local args = string.split(message, " ")

        -- Lệnh :glitch
        if string.sub(message, 1, 7) == ":glitch" then
            if #args > 1 then
                local targetName = args[2]
                local targetPlayer = FindPlayerByName(targetName)
                
                if targetPlayer then
                    local targetPart = targetPlayer.Character and targetPlayer.Character:FindFirstChild("HumanoidRootPart")
                    if targetPart then
                        Module.Hang(targetPart)
                    else
                        print("Không tìm thấy HumanoidRootPart của người chơi.")
                    end
                else
                    print("Không tìm thấy người chơi.")
                end
            end
        
        -- Lệnh :loopglitch
        elseif string.sub(message, 1, 11) == ":loopglitch" then
            if #args > 1 then
                local targetName = args[2]
                local targetPlayer = FindPlayerByName(targetName)
                
                if targetPlayer then
                    if not loopGlitchActive[targetPlayer.Name] then
                        loopGlitchActive[targetPlayer.Name] = true
                        RestoreLoopForPlayer(targetPlayer) -- Bắt đầu loop cho người chơi
                    end
                else
                    print("Không tìm thấy người chơi.")
                end
            end
            
        -- Lệnh :unloopglitch
        elseif string.sub(message, 1, 13) == ":unloopglitch" then
            if #args > 1 then
                local targetName = args[2]
                local targetPlayer = FindPlayerByName(targetName)
                
                if targetPlayer and loopGlitchActive[targetPlayer.Name] then
                    loopGlitchActive[targetPlayer.Name] = false
                else
                    print("Không tìm thấy người chơi hoặc loop chưa được kích hoạt.")
                end
            end
        end
    end
end)

-- Theo dõi sự kiện PlayerAdded
Players.PlayerAdded:Connect(function(player)
    player.CharacterAdded:Connect(function()
        RestoreLoopForPlayer(player) -- Khôi phục loop khi người chơi tham gia lại
    end)
end)

-- Hàm dọn dẹp để hủy tất cả hiệu ứng khi script cũ bị xoá
_G.GlitchCleanup = function()
    _G.GlitchScriptRunning = false
    loopGlitchActive = {} -- Reset trạng thái loop cho tất cả người chơi
    print("Script cũ đã bị hủy.")
end
